GAMIFICATION, PICKUP, AND REFERRAL SYSTEMS ANALYSIS
=====================================================

## GAMIFICATION SYSTEM ##

DATABASE SCHEMA - File: supabase/migrations/20250106_create_gamification_tables.sql

Tables:
1. user_stats (1:1 with users)
   - total_reservations (incremented on RESERVATION INSERT)
   - total_money_saved (calculated on RESERVATION)
   - current_streak_days (based on RESERVATION DATE)
   - longest_streak_days
   - last_activity_date (set to CURRENT_DATE on RESERVATION)
   - total_referrals

2. achievement_definitions (17 achievements, 10-250 points each)
3. user_achievements (tracks unlocked achievements)

CRITICAL: Gamification updates ON RESERVATION, NOT PICKUP!

Trigger: update_stats_on_reservation (AFTER INSERT on reservations)
- Calls update_user_stats_on_reservation()
- Calls update_user_streak()
- Calls check_user_achievements()

Streak Logic (Lines 237-279):
- If last_activity_date == TODAY: already counted
- If last_activity_date == YESTERDAY: increment
- If gap > 1 day: reset to 1
- Update longest_streak_days

User Levels (src/lib/gamification-api.ts Lines 59-105):
- Level 1: Newcomer (0-4 reservations)
- Level 2: Explorer (5-14)
- Level 3: Regular (15-29)
- Level 4: VIP (30-49)
- Level 5: Legend (50+)

SmartPoints (20250105_create_smartpoints_tables.sql):
- Start: 100 points
- Cost: 5 points per reservation
- Reward: 10-250 points per achievement
- Atomic with row-level locking


## PICKUP/RESERVATION FLOW ##

Lifecycle:
1. User creates reservation (ReservationModal.tsx)
2. Deduct 5 SmartPoints
3. Call create_reservation_atomic() RPC
4. TRIGGER FIRES - gamification updated immediately
5. Hours pass...
6. Partner marks picked up (PartnerDashboard.tsx)
7. Status = 'PICKED_UP', picked_up_at = timestamp
8. Gamification NOT updated (already done in step 4)

Atomic Reservation (20251102_atomic_reservation_function.sql):
- Lock offer row FOR UPDATE
- Validate quantity and status
- Decrement offer.quantity_available
- Create reservations record
- Trigger updates user_stats

Pickup Marking (src/lib/api.ts Lines 608-662):
- Function: markAsPickedUp(reservationId)
- Updates ONLY:
  * reservation.status = 'PICKED_UP'
  * picked_up_at = timestamp
- Does NOT:
  * Update gamification
  * Check achievements
  * Award points
  * Update streaks

Partner Dashboard (src/pages/PartnerDashboard.tsx Lines 589-613):
- handleMarkAsPickedUp() calls markAsPickedUp() API
- Can scan QR code to auto-mark pickup


## REFERRAL SYSTEM ##

DATABASE SCHEMA (20250106 Lines 133-150):
- users.referral_code (TEXT, UNIQUE)
- users.referred_by (UUID FK to users)
- user_stats.total_referrals (INT)

Code Generation:
- Function: generate_referral_code() (database)
- API: generateReferralCode(userId) src/lib/gamification-api.ts Lines 259-286
- API: getUserReferralCode(userId) src/lib/gamification-api.ts Lines 291-314
- Generates 6-char alphanumeric code
- Ensures uniqueness

Referral Sharing (src/components/gamification/ReferralCard.tsx):
- URL: https://domain.com?ref=XXXXXX
- Copy to clipboard or native Web Share
- Displays "+50 points for you, +50 for friend"

Code Application:
- Function: applyReferralCode(newUserId, referralCode)
- File: src/lib/gamification-api.ts Lines 319-361
- Steps:
  1. Find referrer by code
  2. Update newUser.referred_by
  3. Increment referrer.total_referrals
  4. Return true

CRITICAL ISSUE: Does NOT award points!
CRITICAL ISSUE: Does NOT check achievements!

Signup Process (src/components/AuthDialog.tsx Lines 98-146):
- handleSignUp() creates account
- Does NOT check for ?ref= parameter
- Does NOT call applyReferralCode()
- Does NOT award points


## WHAT IS WORKING ##

Gamification:
✓ Stats update immediately on reservation
✓ Streaks calculated correctly
✓ Achievements unlock when conditions met
✓ Levels calculated from reservation count
✓ SmartPoints deducted atomically

Pickup:
✓ Pickup status marked correctly
✓ picked_up_at timestamp recorded
✓ QR code validation works
✓ Partner receives notification

Referral:
✓ Codes generated uniquely
✓ Codes shared via URL and Web Share
✓ Referral card UI displays well


## WHAT IS NOT WORKING ##

Referral - BROKEN:
✗ URL ?ref=CODE parameter not read
  - ReferralCard generates it
  - Index.tsx doesn't check for it
  - AuthDialog doesn't check for it
  - New users not linked to referrers

✗ Points NOT awarded on referral
  - applyReferralCode() doesn't call addPoints()
  - Referrer gets +0 (should be +50)
  - New user gets +0

✗ Achievements not checked on referral
  - Friend Magnet (5 referrals) won't unlock
  - Influencer (10 referrals) won't unlock

✗ Referral code not auto-generated
  - Only generated on referral card visit
  - Should be in signup flow


## FILE LOCATIONS ##

Gamification Tables:
  20250106_create_gamification_tables.sql (entire file)

Gamification Triggers:
  Lines 196-234: update_stats_on_reservation trigger
  Lines 237-279: update_user_streak function
  Lines 282-370: check_user_achievements function
  Lines 66-91: achievement definitions

Gamification API:
  src/lib/gamification-api.ts (all functions)

Pickup Atomic:
  20251102_atomic_reservation_function.sql Lines 1-99

Pickup API:
  src/lib/api.ts Lines 608-662

Partner Dashboard:
  src/pages/PartnerDashboard.tsx Lines 589-613 (pickup)
  src/pages/PartnerDashboard.tsx Lines 615-629 (QR validation)

Referral Code Gen:
  20250106_create_gamification_tables.sql Lines 174-193
  src/lib/gamification-api.ts Lines 259-286

Referral Get Code:
  src/lib/gamification-api.ts Lines 291-314

Referral Apply:
  src/lib/gamification-api.ts Lines 319-361

Referral UI:
  src/components/gamification/ReferralCard.tsx

Signup:
  src/components/AuthDialog.tsx Lines 98-146

Main Page (no referral code):
  src/pages/Index.tsx


## IMMEDIATE FIXES ##

1. Add URLSearchParams handling to AuthDialog
2. Check for ?ref= before signup
3. Call applyReferralCode() after user created
4. Modify applyReferralCode() to award points:
   await addPoints(referrer.id, 50, 'referral')
5. Call check_user_achievements(referrer.id)
6. Generate referral code on signup
7. Test end-to-end

## SUMMARY ##

Gamification and pickup systems: WORKING WELL
- Updates correctly on reservation
- Streaks based on reservation date (intentional)
- Clean separation from pickup flow

Referral system: 50% COMPLETE
- Code generation: 100%
- Code sharing: 100%
- Code application: 20% (no points, no achievements)
- URL integration: 0%

All code is secure with proper RLS and atomic operations.
