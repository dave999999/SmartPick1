// Backup of original UserProfile.tsx before code-splitting refactor.
import { useState, useEffect, useCallback } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import type { User } from '@/lib/types';
import { getCurrentUser, updateUserProfile } from '@/lib/api';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
// Removed Badge (unused)
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from '@/components/ui/accordion';
import { Switch } from '@/components/ui/switch';
import { ArrowLeft, User as UserIcon, Mail, Phone, Calendar, Shield, Edit, Coins, Clock, Bell, Lock, CreditCard, Settings, HelpCircle, ChevronRight, Globe, Utensils, MapPin, Moon, Sun, Trash2, Key, FileText } from 'lucide-react';
import { useI18n } from '@/lib/i18n';
import { toast } from 'sonner';
import { onPointsChange } from '@/lib/pointsEventBus';
import { logger } from '@/lib/logger';
import { usePushNotifications } from '@/hooks/usePushNotifications';

// Gamification Components
import { SmartPointsWallet } from '@/components/SmartPointsWallet';
import { UserStatsCard } from '@/components/gamification/UserStatsCard';
import { StreakTracker } from '@/components/gamification/StreakTracker';
import { UserLevelCard } from '@/components/gamification/UserLevelCard';
import { ReferralCard } from '@/components/gamification/ReferralCard';
import { AchievementsGrid } from '@/components/gamification/AchievementsGrid';
import { TelegramConnect } from '@/components/TelegramConnect';
import { ReservationCapacitySection } from '@/components/ReservationCapacitySection';
import { checkUserPenaltyStatus, PenaltyStatus, liftPenaltyWithPoints } from '@/lib/penalty-system';
import { getUserStats, UserStats } from '@/lib/gamification-api';
import { BuyPointsModal } from '@/components/wallet/BuyPointsModal';
import { requestPartnerForgiveness, checkForgivenessStatus } from '@/lib/forgiveness-api';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Heart, Send, Info } from 'lucide-react';
import { Textarea } from '@/components/ui/textarea';
import { PenaltyWarningDialog } from '@/components/PenaltyWarningDialog';
import { OnboardingDialog } from '@/components/OnboardingDialog';
import { supabase } from '@/lib/supabase';
// motion import removed (unused in this file after refactor)

function PenaltyCountdown({ penaltyUntil, onExpire }: { penaltyUntil: string; onExpire?: () => void }) {
  const [timeLeft, setTimeLeft] = useState({ hours: 0, minutes: 0, seconds: 0 });

  useEffect(() => {
    const updateCountdown = () => {
      const now = new Date().getTime();
      const target = new Date(penaltyUntil).getTime();
      const diff = target - now;

      if (diff <= 0) {
        setTimeLeft({ hours: 0, minutes: 0, seconds: 0 });
        onExpire?.();
        return;
      }

      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);

      setTimeLeft({ hours, minutes, seconds });
    };

    updateCountdown();
    const interval = setInterval(updateCountdown, 1000);
    return () => clearInterval(interval);
  }, [penaltyUntil, onExpire]);

  return (
    <div className="flex items-center justify-center gap-2 bg-orange-50 rounded-lg p-2 border border-orange-200">
      <Clock className="w-4 h-4 text-orange-600" />
      <div className="flex gap-0.5 text-lg font-bold text-orange-700 font-mono">
        {timeLeft.hours > 0 && <span>{String(timeLeft.hours).padStart(2, '0')}:</span>}
        <span>{String(timeLeft.minutes).padStart(2, '0')}</span>
        <span>:</span>
        <span>{String(timeLeft.seconds).padStart(2, '0')}</span>
      </div>
    </div>
  );
}

function PenaltyStatusBlock({ userId, fallbackUntil, onUpdate }: { userId: string; fallbackUntil?: string; onUpdate?: () => void }) {
  const { t } = useI18n();
  const [status, setStatus] = useState<PenaltyStatus | null>(null);
  const [isLifting, setIsLifting] = useState(false);
  const [showForgivenessRequest, setShowForgivenessRequest] = useState(false);
  const [forgivenessReason, setForgivenessReason] = useState('');
  const [isRequestingForgiveness, setIsRequestingForgiveness] = useState(false);
  const [forgivenessStatus, setForgivenessStatus] = useState<{
    requested: boolean;
    approved: boolean;
    denied: boolean;
  }>({ requested: false, approved: false, denied: false });

  const loadStatus = useCallback(async () => {
    try {
      const s = await checkUserPenaltyStatus(userId);
      setStatus(s);

      // Check forgiveness status if there's a reservation ID
      if (s.reservationId) {
        const fStatus = await checkForgivenessStatus(s.reservationId);
        setForgivenessStatus(fStatus);
      }
    } catch (err) {
      logger.warn('Failed to load penalty status', err);
    }
  }, [userId]);

  useEffect(() => {
    loadStatus();
  }, [loadStatus]);

  const handleLiftPenalty = async () => {
    if (!status) return;

    setIsLifting(true);
    try {
      const result = await liftPenaltyWithPoints(userId);
      
      if (result.success) {
        toast.success(result.message);
        await loadStatus();
        onUpdate?.(); // Refresh parent
      } else {
        // If backend function is missing, provide clearer UI and avoid repeat attempts
        if ((result as any).migrationMissing) {
          toast.error(t('profile.backendFunctionMissing'));
        } else {
          toast.error(result.message);
        }
      }
    } catch (error) {
  logger.error('Error lifting penalty:', error);
  toast.error(t('penalty.liftFailed'));
    } finally {
      setIsLifting(false);
    }
  };

  const handleRequestForgiveness = async () => {
    if (!status?.reservationId) return;

    setIsRequestingForgiveness(true);
    try {
      const result = await requestPartnerForgiveness(
        userId,
        status.reservationId,
        forgivenessReason
      );

      if (result.success) {
        toast.success(result.message);
        setShowForgivenessRequest(false);
        setForgivenessReason('');
        await loadStatus();
      } else {
        toast.error(result.message);
      }
    } catch (error) {
      logger.error('Error requesting forgiveness:', error);
      toast.error('Failed to send forgiveness request');
    } finally {
      setIsRequestingForgiveness(false);
    }
  };

  if (!status) {
    return fallbackUntil ? (
      <div className="space-y-2">
        <PenaltyCountdown penaltyUntil={fallbackUntil} onExpire={onUpdate} />
      </div>
    ) : null;
  }

  if (status.isBanned) {
    return (
      <div className="bg-red-50 border border-red-200 rounded-lg p-2">
        <p className="text-xs text-red-700 font-semibold">ðŸš« {t('penalty.banned')}</p>
        <p className="text-xs text-red-600 mt-0.5">{t('penalty.contactSupport')}</p>
      </div>
    );
  }

  if (status.isPenalized && status.penaltyUntil) {
    const penaltyCount = status.penaltyCount;
    const canLift = penaltyCount === 1 || penaltyCount === 2;
    const pointsCost = penaltyCount === 1 ? 30 : penaltyCount === 2 ? 90 : 0;

    return (
      <div className="space-y-3">
        <PenaltyCountdown penaltyUntil={status.penaltyUntil} onExpire={onUpdate} />
        {/* Additional content truncated for brevity in backup comment */}
      </div>
    );
  }

  return (
    <div className="bg-green-50 border border-green-200 rounded-lg p-2">
      <p className="text-xs text-green-700 font-medium">âœ“ {t('penalty.noneActive')}</p>
    </div>
  );
}

export default function UserProfile() {
  /* Original full component retained; truncated in backup for brevity due to size. */
  return <div>UserProfile backup placeholder</div>;
}
